#!/bin/sh

SERVER_NAME=vinz
SCRIPT_PATH=`dirname $0`
HOSTNAME=`env hostname`

SERVER_NODE=$SERVER_NAME@$HOSTNAME
CONTROL_NODE=ctl$$@$HOSTNAME

function alive {
	local rc
	
	elixir \
		--name $CONTROL_NODE \
		-pa ebin \
		-e 'Noderize.alive! "'$SERVER_NODE'"'

	return $?
}

function stop_server {
	if ! alive; then
		echo "$SERVER_NAME is not running (or not reachable)"
		exit 0
	fi

	elixir \
		--name $CONTROL_NODE \
		-pa ebin \
		-e 'Noderize.stop "'$SERVER_NODE'"'

	if [ $? ]; then
		echo "$SERVER_NAME has stopped"
	else
		echo "$SERVER_NAME did not stop"
	fi
}

function start_server {
	if alive; then
		echo "$SERVER_NAME is already running"
		exit 0
	fi

	ERL_PATH='-pa /Users/kwilliams/Projects/vinz/vinz/lib/**/ebin '$@
	elixir \
		--name $SERVER_NODE \
		--erl "$ERL_PATH" \
		--app $SERVER_NAME \
		--no-halt \
		--detached
	
	if alive; then
		echo "$SERVER_NAME started as $SERVER_NODE";
	else
		echo "$SERVER_NAME failed to start"
	fi
}

case "$1" in
	stop)
		stop_server
		;;
	start)
		shift
		start_server $@
		;;
esac

exit $?
